steps:
- name: 'gcr.io/cloud-builders/docker'
  id: BUILD_INGRESS
  args:
    [
      'build', '-t', '${_IMAGE_INGRESS}',
      '-f', './Dockerfile.ingress-gcp',
      '--network=cloudbuild',
      '--platform', 'linux/amd64',
      '.'
    ]

- name: 'gcr.io/cloud-builders/docker'
  id: BUILD_BACKEND
  args:
    [
      'build', '-t', '${_IMAGE_BACKEND}',
      '-f', './Dockerfile.backend',
      '--network=cloudbuild',
      '--platform', 'linux/amd64',
      '.'
    ]

- name: 'gcr.io/cloud-builders/docker'
  id: BUILD_VALIDATOR
  args:
    [
      'build', '-t', '${_IMAGE_VALIDATOR}',
      '-f', './Dockerfile.validator',
      '--network=cloudbuild',
      '--platform', 'linux/amd64',
      '.'
    ]

- name: 'gcr.io/cloud-builders/docker'
  id: PUSH_INGRESS
  args:
    [
      'push', '${_IMAGE_INGRESS}'
    ]
  waitFor: BUILD_INGRESS

- name: 'gcr.io/cloud-builders/docker'
  id: PUSH_BACKEND
  args:
    [
      'push', '${_IMAGE_BACKEND}'
    ]
  waitFor: BUILD_BACKEND

- name: 'gcr.io/cloud-builders/docker'
  id: PUSH_VALIDATOR
  args:
    [
      'push', '${_IMAGE_VALIDATOR}'
    ]
  waitFor: BUILD_VALIDATOR

substitutions:
  _REPO: "ob-app-sidecar-repo"
  _REGISTRY: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}"
  _NAME_INGRESS: "ob-app-sidecar-ingress"
  _IMAGE_INGRESS: "${_REGISTRY}/${_NAME_INGRESS}:${COMMIT_SHA}"
  _NAME_BACKEND: "ob-app-sidecar-backend"
  _IMAGE_BACKEND: "${_REGISTRY}/${_NAME_BACKEND}:${COMMIT_SHA}"
  _NAME_VALIDATOR: "ob-app-sidecar-validator"
  _IMAGE_VALIDATOR: "${_REGISTRY}/${_NAME_VALIDATOR}:${COMMIT_SHA}"

options:
  dynamic_substitutions: true
  logging: CLOUD_LOGGING_ONLY
